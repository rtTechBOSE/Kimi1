name: Firmware Build & Release (macOS)

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  release-fw:
    name: Build and Release Firmware (macOS on tag)
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: macos-14
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Ensure mpy-cross is executable
        shell: bash
        run: chmod +x "${GITHUB_WORKSPACE}/pythonCode/mpy-cross"

      - name: Write version.txt (tag/date/actor)
        shell: bash
        run: |
          set -euo pipefail
          REPO_FULL="${{ github.repository }}"
          REPO="${REPO_FULL##*/}"
          TAG="${{ github.ref_name }}"
          DATE="$(date -u '+%Y%m%d%H%M%S')"
          VERSION="${REPO}__${TAG}__${DATE}"
          echo "${VERSION}" > "${GITHUB_WORKSPACE}/pythonCode/fw_upload_to_pyboard/version.txt"

      - name: Build firmware ZIP via build_fw.py
        shell: bash
        run: |
          set -euo pipefail
          python3 "${GITHUB_WORKSPACE}/pythonCode/build_fw.py"

      - name: Verify release assets exist
        id: verify_assets
        shell: bash
        run: |
          set -euo pipefail
          FW_ZIP="${GITHUB_WORKSPACE}/pythonCode/fw_upload_to_pyboard.zip"
          UF2="${GITHUB_WORKSPACE}/pythonCode/fw/firmware.uf2"
          if [ ! -f "$FW_ZIP" ]; then
            echo "::error::Missing firmware ZIP at $FW_ZIP"; exit 1; fi
          if [ ! -f "$UF2" ]; then
            echo "::error::Missing UF2 firmware at $UF2"; exit 1; fi
          echo "fw_zip=$FW_ZIP" >> "$GITHUB_OUTPUT"
          echo "uf2=$UF2" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            ${{ steps.verify_assets.outputs.fw_zip }}
            ${{ steps.verify_assets.outputs.uf2 }}
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          draft: false
          prerelease: false
